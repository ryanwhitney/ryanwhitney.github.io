<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name='viewport' 
 content='width=device-width, initial-scale=1.0, maximum-scale=1.0, 
 user-scalable=0'>
     <title>dotter</title>
    
    <style>
    
    /* CSS files add styling rules to your content */
    *{
      color: white;
      font-family:  SFMono-Regular, "SFMono-Regular", SFMono, Menlo,
        Monaco, Consolas,"Liberation Mono","Courier New", monospace;
      text-transform: lowercase;
    }
    label{
      text-shadow: -1px 1px 0 rgba(0,0,0,.2),
                    1px 1px 0 rgba(0,0,0,.2),
                   1px -1px 0 rgba(0,0,0,.2),
                  -1px -1px 0 rgba(0,0,0,.2),
                  0px 1px 0 rgba(0,0,0,.2),
                  1px 0px 0 rgba(0,0,0,.2);
    }
    body {
      font-family: helvetica, arial, sans-serif;
      height: 100vh;
      margin: 0;
      font-size: 12px;
      background-color: #000;
    }
    .tools{
      display: flex;
      height: 10%;
      justify-content: space-around;
    }
    #grid-container{
      -webkit-touch-callout: none; /* iOS Safari */
      -webkit-user-select: none; /* Safari */
       -khtml-user-select: none; /* Konqueror HTML */
         -moz-user-select: none; /* Old versions of Firefox */
          -ms-user-select: none; /* Internet Explorer/Edge */
              user-select: none; /* Non-prefixed version, currently supported by Chrome, Edge, Opera and Firefox */
    }
    .board-container{
      display: flex;
      justify-content:space-around;
      align-content: center;
    }
    .board{
      display: grid;
      grid-gap: 3px 3px;
      grid-template-rows: 20px 20px 20px 20px 20px 20px 20px 20px 20px 20px 20px 20px 20px 20px 20px 20px;
      grid-template-columns: 20px 20px 20px 20px 20px 20px 20px 20px 20px 20px 20px 20px 20px 20px 20px 20px;
    }
    .dot{
      background-color: #19181A;
    }  
    input[type=color]{
      /* border: none;
      background-color: transparent; */
    }
    input[type=number]{
      background-color:transparent;
    }
    button{
      background-color: black;
      border-width: 1px;
    }
    #more-tools{
      display: flex;
      position: absolute;
      bottom: 10px;
      left: 10px;
    }
    #undo-tile-scale, #undo-tile-gap{
      display: none;
    }
    #undo-button{
      opacity: .5;
      transition: opacity .1s ease-in-out;
    }
    #redo-button{
      opacity: .5;
      transition: opacity .1s ease-in-out;
    }
    #undo-history:first-child { margin-top: auto }
    #undo-history{
      display: flex;
      flex-direction: row-reverse;
      justify-content:  flex-end;
      flex-wrap: nowrap;
      white-space: nowrap;
      margin-top: 20px;
      border: 1px solid rgba(255,255,255,.2);
      padding: 10px;
      max-width: 95%;
      overflow-x: scroll;
      margin: 30px auto 0;
    }
    #undo-history .board{
      grid-gap: 0 0;
      margin-right: 10px;
      grid-template-rows: 2px 2px 2px 2px 2px 2px 2px 2px 2px 2px 2px 2px 2px 2px 2px 2px;
      grid-template-columns: 2px 2px 2px 2px 2px 2px 2px 2px 2px 2px 2px 2px 2px 2px 2px 2px;
    }
    #undo-history .dot{

    }
    </style>
  </head>  
  <body>
    <div class="tools">
      <div id="initial-dot-color-select">
        <label for="select-color">Initial Dot Color</label>
        <input type="color" id="initial-dot-color-selected" name="select-initial-dot-color"
           value="#1f1f1f">
      </div>
      <div id="color-select">
        <label for="select-color">New Dot Color</label>
        <input type="color" id="color-selected" name="select-color"
           value="#e66465">
      </div>
      <div id="background-select">
        <label for="select-color">Background Color</label>
        <input type="color" id="background-color-selected" name="select-background-color"
           value="#19181A">
      </div>
      <div id="select-dot-radius-amount" style="width:80px;">
        <label for="select-dot-radius-amount">dot radius</label>
        <input type="number" id="dot-radius-amount" name="select-dot-radius-amount"
           value="0" style="width:80px;">
      </div>
      <div id="select-glow-amount" style="width:60px;">
        <label for="select-glow-amount">glow</label>
        <input type="number" id="glow-amount" name="select-glow-amount"
           value="0" style="width:40px;">
      </div>
      <div class="undo">
        <button id="undo-button" disabled>undo</button>
      </div>
      <div class="redo">
        <button id="redo-button" disabled>redo</button>
      </div>
    </div>
    <div id="grid-container" class="board-container">
    </div>
    <div id="more-tools">
      <div class="check">
        <label for="enable-undo-visualizer">Enable undo visualizer</label>
        <input type="checkbox" id="enable-undo-visualizer" name="enable-undo-visualizer">
      </div>
      <div id="undo-tile-scale">
        <label for="select-undo-tile-scale">&nbsp;&nbsp; scale</label>
        <input type="number" id="select-undo-tile-scale" name="select-undo-tile-scale" value="2" style="width:40px;">
      </div>
      <div id="undo-tile-gap">
        <label for="select-undo-tile-gap">&nbsp;&nbsp; gap</label>
        <input type="number" id="select-undo-tile-gap" name="select-undo-tile-gap" value="0" style="width:40px;">
      </div>
    </div>
    
    <script>
      
      var gridContainer,
        bgColorSelect = document.getElementById("background-color-selected"),
        initialDotColorSelect = document.getElementById("initial-dot-color-selected"),
        glowAmountSelect = document.getElementById("glow-amount"),
        dotRadiusSelect = document.getElementById("dot-radius-amount"),
        colorWell = document.getElementById("color-selected"),
        undoTileScaleContainer = document.getElementById("undo-tile-scale"),
        undoTileScale = document.getElementById("select-undo-tile-scale"),
        undoTileGapContainer = document.getElementById("undo-tile-gap"),
        undoTileGap = document.getElementById("select-undo-tile-gap"),
        defaultColor = "#000ff0",
        undoStack = [],
        grid,
        undoPresses = 0,
        undoCount = 0,
        undoButton = document.getElementById("undo-button"),
        BOARD_SIZE = 16,
        dotBoard,
        dotCount,
        dot,
        i,
        color,
        undoSize,
        currentUndoSpot,
        currentUndoSpotFromIndex,
        UNDO_VISUALIZER = false; 
             
              
      function saveValues(){
        initialDotColor
        newDotColor
        backgroundColor
        dotRadius
        dotGlow
      };
      
      function updateInitialDotColor(color){
        const style = document.createElement('style');
        style.innerHTML = `
          .dot {
              --dotColor: ` + color + `;
              background-color: var(--dotColor);
          }`;     
        // append the style to the DOM in <head> section
        document.head.appendChild(style);
        saveValues();
      }
      function updateBackgroundColor(color){
        const style = document.createElement('style');
        style.innerHTML = `
          body {
              --bgColor: ` + color + `;
              background-color: var(--bgColor);
          }`;     
        // append the style to the DOM in <head> section
        document.head.appendChild(style);
      }      
      function startup() {
        document.body.style.backgroundColor = bgColorSelect.value;
        const style = document.createElement('style');
        // add CSS styles
        style.innerHTML = `
            .dot {
                background-color:`+ initialDotColorSelect.value+`
            }
        `;     
        // append the style to the DOM in <head> section
        document.head.appendChild(style);
        // CREATE BOARD
        gridContainer = document.getElementById('grid-container');
        dotBoard = document.createElement("div");
        dotBoard.className = "board board0";
        gridContainer.appendChild(dotBoard);        
        dotCount = BOARD_SIZE * BOARD_SIZE
        for (i = 0; i<dotCount; i++) {
          dot = dot+i;
          dot = document.createElement("div");
          dot.className = "dot";
          dotBoard.appendChild(dot);
        }
        
        // ADD INITIAL STATE TO UNDO STACK
        grid = document.getElementById('grid-container');
        var gridContent = grid.innerHTML;        
        undoStack.push(gridContent);

      };
      
      
      startup();
      
      
      var undoVisualizerCheckbox = document.querySelector("input[name=enable-undo-visualizer]");
      
      undoVisualizerCheckbox.addEventListener( 'change', function() {
          if(this.checked) {
              UNDO_VISUALIZER = true;
              var undoVisualizer = document.createElement("div");
              undoVisualizer.id = "undo-history";
              gridContainer.after(undoVisualizer);
              undoVisualizer.innerHTML = "";
              undoStack.forEach(element =>
                undoVisualizer.innerHTML += element
              );
              undoTileScaleContainer.style.display = "block";
              undoTileGapContainer.style.display = "block";
          } else {
            UNDO_VISUALIZER = false;
            var undoVisualizer = document.getElementById('undo-history');
            undoVisualizer.remove();
            undoTileScaleContainer.style.display = "none";
            undoTileGapContainer.style.display = "none";
          }
      });
      
      function updateUndoVisualizerScale(n){
        var n = n + "px"; 
        const style = document.createElement('style');
        style.innerHTML = `
          #undo-history .board{
            grid-template-rows:` + n + ` ` + n + ` ` + n + ` ` + n + ` ` + n + ` ` + n + ` ` + n + ` ` + n + ` ` + n + ` ` + n + ` ` + n + ` ` + n + ` ` + n + ` ` + n + ` ` + n + ` ` + n + ` ` + `;
            grid-template-columns:` + n + ` ` + n + ` ` + n + ` ` + n + ` ` + n + ` ` + n + ` ` + n + ` ` + n + ` ` + n + ` ` + n + ` ` + n + ` ` + n + ` ` + n + ` ` + n + ` ` + n + ` ` + n + ` ` + `;
          } `;   
        // append the style to the DOM in <head> section
        document.head.appendChild(style);
      }
      
      undoTileGap.addEventListener("input", function() {
        const style = document.createElement('style');
        if (undoTileGap.value > 0){
          style.innerHTML = `
            #undo-history .board {
                grid-gap: `  + undoTileGap.value + `px `  + undoTileGap.value + `px;
            }`;     
        }else{
          style.innerHTML = `
          #undo-history .board {
              grid-gap: 0 0;
          }`; 
        }
        document.head.appendChild(style);
        
        updateUndoVisualizerScale(undoTileScale.value - 1);
        setTimeout(function(){ 
          updateUndoVisualizerScale(undoTileScale.value); 
        }, 10);
      }, false); 
      
      undoTileScale.addEventListener("input", function() {
        updateUndoVisualizerScale(undoTileScale.value);
      }, false); 
      
      glowAmountSelect.addEventListener("input", function() {
        var dots = document.querySelectorAll(".dot");
        dots.forEach(item => 
          item.style.cssText += `box-shadow: 0 0 ` + glowAmountSelect.value + `px  var(--dotColor),
               0 0 ` + glowAmountSelect.value + `px  var(--dotColor);`
        );
      }, false); 
      dotRadiusSelect.addEventListener("input", function() {
        const style = document.createElement('style');
        style.innerHTML = `
          .dot {
              border-radius:` + dotRadiusSelect.value + `px;
          }`;     
        // append the style to the DOM in <head> section
        document.head.appendChild(style);
      }, false); 
            
      initialDotColorSelect.addEventListener("input", function() {
        updateInitialDotColor(initialDotColorSelect.value);
      }, false); 
         
      bgColorSelect.addEventListener("input", function() {
        document.body.style.backgroundColor = bgColorSelect.value;
      }, false); 
      
      function initiateBoard(){
        // BIND KEYBOARD CLICKS TO DOTS
        var pressed = false;
        const dots = document.querySelectorAll(".dot");
        
        Array.prototype.forEach.call(dots, function(dot, i) {
          dot.onmousedown = function() {
            pressed = true;
            change(dot);
            undoStackReset();
          };
          dot.onmouseenter = function() {
            if (pressed == true) {
              change(dot);
            }
          };
          dot.onmouseup = function() {
            pressed = false;
            undoStackAdd();
            updateUndoButton()
          };
          dot.onmouseout = function() {
            if (pressed == true) {
              // i don't think there's anything to cancel 
            }
          }
        });
        
        
        
      
        
      }
      // WHAT HAPPENS WHEN A DOT IS CLICKED
      function change(dot) {
        
        // let root = document.documentElement;
        // dot.style.backgroundColor = colorWell.value;
        dot.style.cssText += `--dotColor: ` + colorWell.value + `;background-color: var(--dotColor);z-index:99999;`;
      }
      initiateBoard();
      
      function undoStackAdd(){
        undoCount += 1;
        console.log("undocount: " + undoCount);
        
        // ADD A CLONE OF THE GRID TO AN ARRAY
        grid = document.getElementById('grid-container');
        grid.firstElementChild.className = "board board" + undoStack.length;
        var gridContent = grid.innerHTML;

        undoStack.push(gridContent);
        
        // // limit stack to 50?
        // if (undoStack.length > 50) {
        //   undoStack.length = 50;
        // }
        if (UNDO_VISUALIZER == true){
          var undoVisualizer = document.getElementById('undo-history');
          undoVisualizer.innerHTML = "";
          undoStack.forEach(element =>
            undoVisualizer.innerHTML += element
          );
        }
      }
      
      function undoStackReset(){
        if (currentUndoSpot > 0){
          undoStack = undoStack.slice(0,currentUndoSpot);
          console.log("sliced to: " + undoStack.length);
          undoPresses = 0;
          undoCount = 0;
          undoSize = 0;
          currentUndoSpot = 0;
        }
      }
      
      // UPDATE UNDO BUTTON THINGS ON CHANGE
      function updateUndoButton(currentSpot){
        if (undoCount > 0){
          undoButton.disabled = false;
          undoButton.style.opacity = 1;
          if (currentSpot == 0){
            undoButton.disabled = true;
            undoButton.style.opacity = .5;
          };
        } else{
          undoButton.disabled = true;
          undoButton.style.opacity = .5;
        }
      }
      
      // WHEN THE UNDO BUTTON IS PRESSED
      document.getElementById("undo-button").onclick = function(){
        
        // get size of undo array
        let undoSize = undoStack.length;
        
        // count how many times button was pressed
        undoPresses += 1;
        
        // get the target undo location (and location counting from 0 lol)
        currentUndoSpot = undoSize - undoPresses;        
        currentUndoSpotFromIndex = currentUndoSpot - 1;
        
        // put desired undo into the main editor
        document.getElementById('grid-container').innerHTML = undoStack[currentUndoSpotFromIndex];
        
        // light up current item in undo stack
        if (UNDO_VISUALIZER == true){
          let getLastUndoIndex = "board" + currentUndoSpotFromIndex;
          document.querySelectorAll(".board").forEach(
            function(board) {
              if (board.classList.contains(getLastUndoIndex)){
                board.style.border = "1px solid white"
              } else{
                board.style.border = "none";
              }
            }
          )
        }
        
        updateUndoButton(currentUndoSpotFromIndex);
        
        // re-set-up bindings 
        initiateBoard();
      }; 
    </script>
  </body>
</html>
